# Official Bun image
FROM oven/bun:1.3 AS base
WORKDIR /usr/src/app

# Install all deps and build the project (produces dist/ via `bun build`)
FROM base AS builder
COPY package.json ./
RUN  bun install --frozen-lockfile
COPY . .
# run the project's build script (expects `build` script in package.json)
RUN bun run build

# Final image: copy production node_modules and the built output (dist)
FROM oven/bun:1.3 AS release
WORKDIR /usr/src/app
# COPY --from=deps /usr/src/app/node_modules node_modules
COPY --from=builder /usr/src/app/dist dist
# COPY package.json ./

USER bun
EXPOSE 3000/tcp
# Start the built bundle. The project build should output dist/index.js
CMD [ "bun", "dist/index.js" ]